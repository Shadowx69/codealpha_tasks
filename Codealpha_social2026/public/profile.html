<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Social 2026</title>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-gray-100 font-sans antialiased text-gray-900">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <span class="text-2xl font-bold text-blue-600 tracking-tight">Social 2026</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4 flex-grow justify-end max-w-sm mr-4 relative">
                    <input type="text" id="searchInput" placeholder="Search users..."
                        class="w-full bg-gray-100 border-none rounded-full px-4 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="searchResults"
                        class="absolute top-full w-full bg-white mt-2 rounded-lg shadow-lg border border-gray-100 hidden z-50 max-h-60 overflow-y-auto">
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/feed.html"
                        class="text-gray-500 hover:text-blue-600 font-medium transition-colors">Home</a>
                    <a href="#" id="navProfileLink"
                        class="text-gray-900 font-medium hover:text-blue-600 transition-colors">Profile</a>
                    <button id="logoutBtn"
                        class="bg-gray-100 text-gray-700 px-4 py-2 rounded-full font-medium text-sm hover:bg-gray-200 transition-colors">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-2xl mx-auto mt-8 px-4 sm:px-6">

        <!-- Profile Header -->
        <div id="profileHeader" class="bg-white rounded-xl shadow-sm p-8 mb-6 text-center animate-pulse">
            <div class="h-8 bg-gray-200 rounded w-1/3 mx-auto mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-1/4 mx-auto"></div>
        </div>

        <!-- User's Posts -->
        <h3 class="text-lg font-bold text-gray-800 mb-4 px-2">Posts</h3>
        <div id="postsFeed" class="space-y-6 pb-12">
            <div class="text-center text-gray-500 py-10" id="loadingFeed">Loading posts...</div>
        </div>

    </main>

    <script>
        let currentUserId = null;
        let currentUserIsSelf = false;
        const urlParams = new URLSearchParams(window.location.search);
        const profileId = urlParams.get('id');

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/login.html';
        });

        async function init() {
            if (!profileId) {
                window.location.href = '/feed.html';
                return;
            }

            try {
                const meRes = await fetch('/api/me');
                if (!meRes.ok) {
                    window.location.href = '/login.html';
                    return;
                }
                const me = await meRes.json();
                currentUserId = me.userId;
                document.getElementById('navProfileLink').href = `/profile.html?id=${me.userId}`;

                await loadProfile();
            } catch (e) { console.error(e); }
        }

        async function loadProfile() {
            const header = document.getElementById('profileHeader');
            const feed = document.getElementById('postsFeed');
            try {
                const res = await fetch(`/api/users/${profileId}`);
                if (!res.ok) {
                    header.innerHTML = '<div class="text-red-500 text-xl font-bold">User not found.</div>';
                    feed.innerHTML = '';
                    header.classList.remove('animate-pulse');
                    return;
                }
                const data = await res.json();
                const user = data.user;
                const posts = data.posts;
                currentUserIsSelf = user.is_self;

                // Render Header
                header.classList.remove('animate-pulse');

                let followBtnHtml = '';
                if (!user.is_self) {
                    const btnClass = user.is_followed ?
                        'bg-gray-200 text-gray-800 hover:bg-red-100 hover:text-red-600' :
                        'bg-blue-600 text-white hover:bg-blue-700';
                    const btnText = user.is_followed ? 'Following' : 'Follow';
                    followBtnHtml = `<button onclick="toggleFollow()" id="followBtn" class="mt-4 px-8 py-2 rounded-full font-medium transition-colors ${btnClass}">${btnText}</button>`;
                }

                header.innerHTML = `
                    <div class="w-24 h-24 bg-gradient-to-tr from-blue-400 to-blue-600 rounded-full mx-auto mb-4 flex items-center justify-center text-white text-4xl font-bold shadow-md">
                        ${user.username.charAt(0).toUpperCase()}
                    </div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-1">@${user.username}</h1>
                    <p class="text-gray-500 text-sm mb-4">Joined ${new Date(user.created_at).toLocaleDateString()}</p>
                    <div class="flex justify-center space-x-8 text-gray-700 mb-2">
                        <div class="text-center">
                            <span class="block font-bold text-xl">${user.followers_count}</span>
                            <span class="text-xs uppercase tracking-wide text-gray-500">Followers</span>
                        </div>
                        <div class="text-center">
                            <span class="block font-bold text-xl">${user.following_count}</span>
                            <span class="text-xs uppercase tracking-wide text-gray-500">Following</span>
                        </div>
                    </div>
                    ${followBtnHtml}
                `;

                // Render Posts
                if (posts.length === 0) {
                    feed.innerHTML = '<div class="text-center text-gray-500 py-10 bg-white rounded-xl shadow-sm">No posts to show.</div>';
                    return;
                }

                feed.innerHTML = '';
                posts.forEach(p => {
                    const likedClass = p.user_liked ? 'text-blue-600' : 'text-gray-500';
                    const postEl = document.createElement('div');
                    postEl.className = 'bg-white rounded-xl shadow-sm overflow-hidden transform transition hover:-translate-y-1 hover:shadow-md';
                    postEl.innerHTML = `
                        <div class="p-5">
                            <div class="flex items-center justify-between mb-4">
                                <span class="font-bold text-gray-900">@${user.username}</span>
                                <span class="text-sm text-gray-500">${new Date(p.created_at).toLocaleString()}</span>
                            </div>
                            <p class="text-gray-800 whitespace-pre-wrap text-lg mb-4">${escapeHtml(p.content)}</p>
                            
                            <div class="flex items-center space-x-6 border-t border-gray-100 pt-3 text-sm font-medium">
                                <button onclick="toggleLike(${p.id}, this)" class="flex items-center space-x-2 ${likedClass} hover:text-blue-600 transition-colors">
                                    <i class="fa-${p.user_liked ? 'solid' : 'regular'} fa-heart text-lg"></i>
                                    <span class="like-count">${p.like_count}</span>
                                </button>
                                <button onclick="toggleComments(${p.id})" class="flex items-center space-x-2 text-gray-500 hover:text-blue-600 transition-colors">
                                    <i class="fa-regular fa-comment text-lg"></i>
                                    <span>${p.comment_count}</span>
                                </button>
                            </div>
                        </div>
                        
                        <div id="comments-${p.id}" class="hidden bg-gray-50 border-t border-gray-100 p-5">
                            <div id="comments-list-${p.id}" class="space-y-4 mb-4"></div>
                            <form onsubmit="addComment(event, ${p.id})" class="flex mt-2">
                                <input type="text" id="comment-input-${p.id}" required placeholder="Write a comment..." class="flex-grow rounded-l-full border-gray-300 px-4 py-2 border focus:outline-none focus:border-blue-500 text-sm">
                                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-r-full hover:bg-blue-700 text-sm font-medium">Post</button>
                            </form>
                        </div>
                    `;
                    feed.appendChild(postEl);
                });

            } catch (e) {
                console.error(e);
                feed.innerHTML = '<div class="text-center text-red-500 py-10">Error loading profile.</div>';
            }
        }

        async function toggleFollow() {
            const btn = document.getElementById('followBtn');
            btn.disabled = true;
            await fetch(`/api/users/${profileId}/follow`, { method: 'POST' });
            await loadProfile();
        }

        async function toggleLike(postId, btn) {
            const res = await fetch(`/api/posts/${postId}/like`, { method: 'POST' });
            const data = await res.json();

            const icon = btn.querySelector('i');
            const countSpan = btn.querySelector('.like-count');
            let count = parseInt(countSpan.textContent);

            if (data.liked) {
                btn.classList.add('text-blue-600');
                btn.classList.remove('text-gray-500');
                icon.classList.remove('fa-regular');
                icon.classList.add('fa-solid');
                countSpan.textContent = count + 1;
            } else {
                btn.classList.remove('text-blue-600');
                btn.classList.add('text-gray-500');
                icon.classList.remove('fa-solid');
                icon.classList.add('fa-regular');
                countSpan.textContent = Math.max(0, count - 1);
            }
        }

        async function toggleComments(postId) {
            const section = document.getElementById(`comments-${postId}`);
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                await loadComments(postId);
            } else {
                section.classList.add('hidden');
            }
        }

        async function loadComments(postId) {
            const list = document.getElementById(`comments-list-${postId}`);
            list.innerHTML = '<div class="text-xs text-gray-500 text-center">Loading...</div>';
            const res = await fetch(`/api/posts/${postId}/comments`);
            const comments = await res.json();

            list.innerHTML = '';
            if (comments.length === 0) {
                list.innerHTML = '<div class="text-xs text-gray-500 text-center">No comments yet.</div>';
            } else {
                comments.forEach(c => {
                    list.innerHTML += `
                        <div class="text-sm">
                            <a href="/profile.html?id=${c.user_id}" class="font-bold text-gray-900 hover:underline">@${c.username}</a>
                            <span class="text-gray-700 ml-1">${escapeHtml(c.content)}</span>
                        </div>
                    `;
                });
            }
        }

        async function addComment(e, postId) {
            e.preventDefault();
            const input = document.getElementById(`comment-input-${postId}`);
            const content = input.value;
            if (!content.trim()) return;

            await fetch(`/api/posts/${postId}/comments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
            });
            input.value = '';
            await loadProfile();
            document.getElementById(`comments-${postId}`).classList.remove('hidden');
            await loadComments(postId);
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Search logic
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');

        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();

            if (!query) {
                searchResults.classList.add('hidden');
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`);
                    const users = await res.json();

                    searchResults.innerHTML = '';
                    if (users.length === 0) {
                        searchResults.innerHTML = '<div class="p-3 text-sm text-gray-500 text-center">No users found</div>';
                    } else {
                        users.forEach(u => {
                            searchResults.innerHTML += `
                                <a href="/profile.html?id=${u.id}" class="block p-3 hover:bg-gray-50 border-b border-gray-50 last:border-0 transition-colors">
                                    <div class="font-medium text-gray-900">@${escapeHtml(u.username)}</div>
                                </a>
                            `;
                        });
                    }
                    searchResults.classList.remove('hidden');
                } catch (e) { console.error(e); }
            }, 300);
        });

        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.add('hidden');
            }
        });

        init();
    </script>
</body>

</html>