<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feed - Social 2026</title>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-gray-100 font-sans antialiased text-gray-900">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <span class="text-2xl font-bold text-blue-600 tracking-tight">Social 2026</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4 flex-grow justify-end max-w-sm mr-4 relative">
                    <input type="text" id="searchInput" placeholder="Search users..."
                        class="w-full bg-gray-100 border-none rounded-full px-4 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="searchResults"
                        class="absolute top-full w-full bg-white mt-2 rounded-lg shadow-lg border border-gray-100 hidden z-50 max-h-60 overflow-y-auto">
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/feed.html"
                        class="text-gray-900 font-medium hover:text-blue-600 transition-colors">Home</a>
                    <a href="#" id="navProfileLink"
                        class="text-gray-500 hover:text-blue-600 font-medium transition-colors">Profile</a>
                    <button id="logoutBtn"
                        class="bg-gray-100 text-gray-700 px-4 py-2 rounded-full font-medium text-sm hover:bg-gray-200 transition-colors">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-2xl mx-auto mt-8 px-4 sm:px-6">

        <!-- Create Post -->
        <div class="bg-white rounded-xl shadow-sm p-4 mb-6 transition-all hover:shadow-md">
            <form id="createPostForm">
                <textarea id="postContent" rows="3"
                    class="w-full resize-none border-0 focus:ring-0 text-lg placeholder-gray-400 bg-transparent mb-2 outline-none p-2"
                    placeholder="What's on your mind?"></textarea>
                <div class="flex justify-end border-t border-gray-100 pt-3">
                    <button type="submit"
                        class="bg-blue-600 text-white px-6 py-2 rounded-full font-medium hover:bg-blue-700 transition-colors disabled:opacity-50">Post</button>
                </div>
            </form>
        </div>

        <!-- Feed List -->
        <div id="postsFeed" class="space-y-6 pb-12">
            <div class="text-center text-gray-500 py-10" id="loadingFeed">Loading feed...</div>
        </div>
    </main>

    <script>
        let currentUserId = null;

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/login.html';
        });

        async function init() {
            try {
                const meRes = await fetch('/api/me');
                if (!meRes.ok) {
                    window.location.href = '/login.html';
                    return;
                }
                const me = await meRes.json();
                currentUserId = me.userId;
                document.getElementById('navProfileLink').href = `/profile.html?id=${me.userId}`;

                await loadPosts();
            } catch (e) { console.error(e); }
        }

        async function loadPosts() {
            const feed = document.getElementById('postsFeed');
            try {
                const res = await fetch('/api/posts');
                const posts = await res.json();

                if (posts.length === 0) {
                    feed.innerHTML = '<div class="text-center text-gray-500 py-10 bg-white rounded-xl shadow-sm">No posts yet. Be the first to post!</div>';
                    return;
                }

                feed.innerHTML = '';
                posts.forEach(p => {
                    const likedClass = p.user_liked ? 'text-blue-600' : 'text-gray-500';
                    const postEl = document.createElement('div');
                    postEl.className = 'bg-white rounded-xl shadow-sm overflow-hidden transform transition hover:-translate-y-1 hover:shadow-md';
                    postEl.innerHTML = `
                        <div class="p-5">
                            <div class="flex items-center justify-between mb-4">
                                <a href="/profile.html?id=${p.author_id}" class="font-bold text-gray-900 hover:underline">@${p.username}</a>
                                <span class="text-sm text-gray-500">${new Date(p.created_at).toLocaleString()}</span>
                            </div>
                            <p class="text-gray-800 whitespace-pre-wrap text-lg mb-4">${escapeHtml(p.content)}</p>
                            
                            <div class="flex items-center space-x-6 border-t border-gray-100 pt-3 text-sm font-medium">
                                <button onclick="toggleLike(${p.id}, this)" class="flex items-center space-x-2 ${likedClass} hover:text-blue-600 transition-colors">
                                    <i class="fa-${p.user_liked ? 'solid' : 'regular'} fa-heart text-lg"></i>
                                    <span class="like-count">${p.like_count}</span>
                                </button>
                                <button onclick="toggleComments(${p.id})" class="flex items-center space-x-2 text-gray-500 hover:text-blue-600 transition-colors">
                                    <i class="fa-regular fa-comment text-lg"></i>
                                    <span>${p.comment_count}</span>
                                </button>
                            </div>
                        </div>
                        
                        <div id="comments-${p.id}" class="hidden bg-gray-50 border-t border-gray-100 p-5">
                            <div id="comments-list-${p.id}" class="space-y-4 mb-4"></div>
                            <form onsubmit="addComment(event, ${p.id})" class="flex mt-2">
                                <input type="text" id="comment-input-${p.id}" required placeholder="Write a comment..." class="flex-grow rounded-l-full border-gray-300 px-4 py-2 border focus:outline-none focus:border-blue-500 text-sm">
                                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-r-full hover:bg-blue-700 text-sm font-medium">Post</button>
                            </form>
                        </div>
                    `;
                    feed.appendChild(postEl);
                });
            } catch (e) {
                feed.innerHTML = '<div class="text-center text-red-500 py-10">Error loading posts.</div>';
            }
        }

        document.getElementById('createPostForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const content = document.getElementById('postContent').value;
            if (!content.trim()) return;

            btn.disabled = true;
            await fetch('/api/posts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
            });
            document.getElementById('postContent').value = '';
            btn.disabled = false;
            await loadPosts();
        });

        async function toggleLike(postId, btn) {
            const res = await fetch(`/api/posts/${postId}/like`, { method: 'POST' });
            const data = await res.json();

            const icon = btn.querySelector('i');
            const countSpan = btn.querySelector('.like-count');
            let count = parseInt(countSpan.textContent);

            if (data.liked) {
                btn.classList.add('text-blue-600');
                btn.classList.remove('text-gray-500');
                icon.classList.remove('fa-regular');
                icon.classList.add('fa-solid');
                countSpan.textContent = count + 1;
            } else {
                btn.classList.remove('text-blue-600');
                btn.classList.add('text-gray-500');
                icon.classList.remove('fa-solid');
                icon.classList.add('fa-regular');
                countSpan.textContent = Math.max(0, count - 1);
            }
        }

        async function toggleComments(postId) {
            const section = document.getElementById(`comments-${postId}`);
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                await loadComments(postId);
            } else {
                section.classList.add('hidden');
            }
        }

        async function loadComments(postId) {
            const list = document.getElementById(`comments-list-${postId}`);
            list.innerHTML = '<div class="text-xs text-gray-500 text-center">Loading...</div>';
            const res = await fetch(`/api/posts/${postId}/comments`);
            const comments = await res.json();

            list.innerHTML = '';
            if (comments.length === 0) {
                list.innerHTML = '<div class="text-xs text-gray-500 text-center">No comments yet.</div>';
            } else {
                comments.forEach(c => {
                    list.innerHTML += `
                        <div class="text-sm">
                            <a href="/profile.html?id=${c.user_id}" class="font-bold text-gray-900 hover:underline">@${c.username}</a>
                            <span class="text-gray-700 ml-1">${escapeHtml(c.content)}</span>
                        </div>
                    `;
                });
            }
        }

        async function addComment(e, postId) {
            e.preventDefault();
            const input = document.getElementById(`comment-input-${postId}`);
            const content = input.value;
            if (!content.trim()) return;

            await fetch(`/api/posts/${postId}/comments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
            });
            input.value = '';
            await loadPosts();
            document.getElementById(`comments-${postId}`).classList.remove('hidden');
            await loadComments(postId);
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Search logic
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');

        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();

            if (!query) {
                searchResults.classList.add('hidden');
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`);
                    const users = await res.json();

                    searchResults.innerHTML = '';
                    if (users.length === 0) {
                        searchResults.innerHTML = '<div class="p-3 text-sm text-gray-500 text-center">No users found</div>';
                    } else {
                        users.forEach(u => {
                            searchResults.innerHTML += `
                                <a href="/profile.html?id=${u.id}" class="block p-3 hover:bg-gray-50 border-b border-gray-50 last:border-0 transition-colors">
                                    <div class="font-medium text-gray-900">@${escapeHtml(u.username)}</div>
                                </a>
                            `;
                        });
                    }
                    searchResults.classList.remove('hidden');
                } catch (e) { console.error(e); }
            }, 300);
        });

        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.add('hidden');
            }
        });

        init();
    </script>
</body>

</html>